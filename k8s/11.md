# Secrets

## Secrets Using `kubectl`

### Creating a Secret

Folowing the guide. Using raw data:

```bash
kubectl create secret generic db-user-pass \
    --from-literal=username=admin \
    --from-literal=password='S!B\*d$zDsb='
```

Output:

```
secret/db-user-pass created
```

### Verifying a secret

 - `kubectl get secrets`

```bash
NAME                                          TYPE                 DATA   AGE
db-user-pass                                  Opaque               2      17s
```

 - `kubectl describe secret db-user-pass`

 ```bash
Name:         db-user-pass
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  12 bytes
username:  5 bytes
 ```

### Decoding a secret

 - `kubectl get secret db-user-pass -o jsonpath='{.data}'`

```bash
{"password":"UyFCXCpkJHpEc2I9","username":"YWRtaW4="}
```

 - `echo 'UyFCXCpkJHpEc2I9' | base64 --decode`

`S!B\*d$zDsb=`

 - `echo 'YWRtaW4=' | base64 --decode`

`admin`

### Manage Secrets with Helm

- `kubectl get po`

```bash
NAME                               READY   STATUS    RESTARTS   AGE
helm-app-python-7b7477675d-fqtzw   1/1     Running   0          47s
```


 - `kubectl exec helm-app-python-7b7477675d-fqtzw -- printenv | grep MY_PASSWORD`

```bash
MY_PASSWORD=secret1234
```

### Install Vault Using Helm Chart

```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
helm repo update
helm install vault hashicorp/vault --set "server.dev.enabled=true"
```

### Set a secret in Vault

```bash
kubectl exec -it vault-0 -- /bin/sh
vault secrets enable -path=internal kv-v2
vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
vault kv get internal/database/config
```

### Configure Kubernetes authentication

```bash
vault auth enable kubernetes
vault write auth/kubernetes/config \
      kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
vault policy write internal-app - <<EOF
path "internal/data/database/config" {
   capabilities = ["read"]
}
EOF
vault write auth/kubernetes/role/internal-app \
      bound_service_account_names=internal-app \
      bound_service_account_namespaces=default \
      policies=internal-app \
      ttl=24h
kubectl create sa internal-app
```

### Implement Vault Secrets

`kubectl patch deployment helm-app-python --patch "$(cat patch-inject-secrets.yaml)"`

 - `kubectl exec -it helm-app-python-ffd7957f4-t5tb7 -- cat /vault/secrets/database-config.txt`

```bash
Defaulted container "helm-app-python" out of: helm-app-python, vault-agent, vault-agent-init (init)
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2024-04-16T02:30:03.999030372Z custom_metadata:<nil> deletion_time: destroyed:false version:2]
```

 - `kubectl exec -it helm-app-python-ffd7957f4-t5tb7 -- df -h`

```bash
Defaulted container "helm-app-python" out of: helm-app-python, vault-agent, vault-agent-init (init)
Filesystem                Size      Used Available Use% Mounted on
overlay                1006.9G     18.9G    936.8G   2% /
tmpfs                    64.0M         0     64.0M   0% /dev
tmpfs                     3.8G         0      3.8G   0% /sys/fs/cgroup
tmpfs                     7.7G      4.0K      7.7G   0% /vault/secrets
/dev/sdd               1006.9G     18.9G    936.8G   2% /dev/termination-log
/dev/sdd               1006.9G     18.9G    936.8G   2% /etc/resolv.conf
/dev/sdd               1006.9G     18.9G    936.8G   2% /etc/hostname
/dev/sdd               1006.9G     18.9G    936.8G   2% /etc/hosts
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                     7.7G     12.0K      7.7G   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                     3.8G         0      3.8G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     3.8G         0      3.8G   0% /sys/firmware
```

### Resource Management

 - `kubectl describe deployments.apps helm-app-python`

```bash
...
   helm-app-python:
    Image:      damirafliatonov/moscow-time-app:latest
    Port:       8000/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
...
```

### Environment Variables

Added the `helm-app-python.envVar` and `helm-app-javascript.envVar` to the `_helper.tpl` files in the charts, then imported them in `deployment.yaml`.
