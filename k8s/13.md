# Kubernetes StatefulSet

## Task 1

 - `helm install --dry-run --debug helm-app-python .`


Output:


```bash
install.go:218: [debug] Original chart version: ""
install.go:235: [debug] CHART PATH: /workspaces/S24-core-course-labs/k8s/helm-app-python

NAME: helm-app-python
LAST DEPLOYED: Tue Apr 30 19:36:58 2024
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
  pullPolicy: Always
  repository: damirafliatonov/moscow-time-app
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: []
library-chart:
  global: {}
livenessProbe:
  httpGet:
    path: /
    port: http
nameOverride: ""
nodeSelector: {}
podAnnotations:
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
  vault.hashicorp.com/role: internal-app
podLabels: {}
podSecurityContext: {}
readinessProbe:
  httpGet:
    path: /
    port: http
replicaCount: 2
resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:
    cpu: 100m
    memory: 128Mi
securityContext: {}
service:
  port: 8000
  type: ClusterIP
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: internal-app
tolerations: []
volumeClaimTemplates:
- metadata:
    name: www
  spec:
    accessModes:
    - ReadWriteOnce
    resources:
      requests:
        storage: 1Gi
volumeMounts:
- mountPath: /app/config.json
  name: config-volume
  subPath: config.json
volumes:
- configMap:
    name: config
  name: config-volume

HOOKS:
---
# Source: helm-app-python/templates/post-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: postinstall-hook
   annotations:
       "helm.sh/hook": "post-install"
       "helm.sh/hook-delete-policy": "hook-succeeded"
spec:
  containers:
  - name: post-install-container
    image: busybox
    imagePullPolicy: Always
    command: ['sh', '-c', 'echo The post-install hook is running && sleep 15' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: helm-app-python/templates/pre-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: preinstall-hook
   annotations:
       "helm.sh/hook": "pre-install"
       "helm.sh/hook-delete-policy": "hook-succeeded"
spec:
  containers:
  - name: pre-install-container
    image: busybox
    imagePullPolicy: IfNotPresent
    command: ['sh', '-c', 'echo The pre-install hook is running && sleep 20' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: helm-app-python/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "helm-app-python-test-connection"
  labels:
    helm.sh/chart: helm-app-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: helm-app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['helm-app-python:8000']
  restartPolicy: Never
MANIFEST:
---
# Source: helm-app-python/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: internal-app
  labels:
    helm.sh/chart: helm-app-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: helm-app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: helm-app-python/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: config
data:
  config.json: |-
    {
        "example": "example data"
    }
---
# Source: helm-app-python/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: helm-app-python
  labels:
    helm.sh/chart: helm-app-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: helm-app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/instance: helm-app-python
---
# Source: helm-app-python/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: helm-app-python
  labels:
    helm.sh/chart: helm-app-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: helm-app-python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: helm-app-python
      app.kubernetes.io/instance: helm-app-python
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
        vault.hashicorp.com/role: internal-app
      labels:
        helm.sh/chart: helm-app-python-0.1.0
        app.kubernetes.io/name: helm-app-python
        app.kubernetes.io/instance: helm-app-python
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: internal-app
      securityContext:
        {}
      containers:
        - name: helm-app-python
          securityContext:
            {}
          image: "damirafliatonov/moscow-time-app:latest"
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: http
          readinessProbe:
            httpGet:
              path: /
              port: http
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
            requests:
              cpu: 100m
              memory: 128Mi
          volumeMounts:
            - mountPath: /app/config.json
              name: config-volume
              subPath: config.json
      volumes:
        - configMap:
            name: config
          name: config-volume
  volumeClaimTemplates:
    - metadata:
        name: www
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi

NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=helm-app-python,app.kubernetes.io/instance=helm-app-python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```


## Task 2

 - `kubectl get po,sts,svc,pvc`

```bash
NAME                                       READY   STATUS    RESTARTS      AGE
pod/helm-app-javascript-6f954bcbc7-bc8cv   1/1     Running   1 (23h ago)   6d17h
pod/helm-app-python-0                      2/2     Running   0             78s
pod/helm-app-python-1                      2/2     Running   0             57s
pod/vault-0                                1/1     Running   2 (23h ago)   14d
pod/vault-agent-injector-dbfc5cd77-s65nw   1/1     Running   2 (23h ago)   14d
pod/web-0                                  1/1     Running   0             3h46m
pod/web-1                                  1/1     Running   0             3h46m

NAME                               READY   AGE
statefulset.apps/helm-app-python   2/2     78s
statefulset.apps/vault             1/1     14d
statefulset.apps/web               2/2     23h

NAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/helm-app-javascript          ClusterIP   10.103.113.54    <none>        3000/TCP            6d17h
service/helm-app-python              ClusterIP   10.108.8.45      <none>        8000/TCP            78s
service/kubernetes                   ClusterIP   10.96.0.1        <none>        443/TCP             28d
service/moscow-time-app-js-service   NodePort    10.98.106.67     <none>        3000:30945/TCP      27d
service/moscow-time-app-service      NodePort    10.97.223.176    <none>        8000:31274/TCP      27d
service/nginx                        ClusterIP   None             <none>        80/TCP              23h
service/vault                        ClusterIP   10.100.213.140   <none>        8200/TCP,8201/TCP   14d
service/vault-agent-injector-svc     ClusterIP   10.107.16.89     <none>        443/TCP             14d
service/vault-internal               ClusterIP   None             <none>        8200/TCP,8201/TCP   14d

NAME                                          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/www-helm-app-python-0   Bound    pvc-48cf602c-8cfb-401c-9ea8-716985a55a9f   1Gi        RWO            standard       3h24m
persistentvolumeclaim/www-helm-app-python-1   Bound    pvc-99ee9209-a2a6-4329-8182-3da65aae8062   1Gi        RWO            standard       57s
persistentvolumeclaim/www-web-0               Bound    pvc-cf09aac4-10b2-4f3c-8a91-693fe5c70880   1Gi        RWO            standard       23h
persistentvolumeclaim/www-web-1               Bound    pvc-6859829f-d5e9-42c2-ac51-ae6979f76f1f   1Gi        RWO            standard       23h
```


 - `kubectl exec pod/helm-app-python-0 -- cat visits/visits`

```
Defaulted container "helm-app-python" out of: helm-app-python, vault-agent, vault-agent-init (init)
74
```

 - `kubectl exec pod/helm-app-python-1 -- cat visits/visits`

```
Defaulted container "helm-app-python" out of: helm-app-python, vault-agent, vault-agent-init (init)
62
```

### Explaining the difference in visits

Pod `helm-app-python-0` has more visits than `helm-app-python-1`.

This difference most likely appears due to the [load balancing](https://kubernetes.io/docs/concepts/services-networking/ingress/#load-balancing) strategy that is used by Kubernetes. It does not guarantee an even distribution of the requests among the replicas.

In my case, most probably the `helm-app-python-1` pod only received healthcheck requests, while the other one - both helthchecks and the requests made by me.

### Explain why ordering guarantees are unnecessary for your app

Ordering guarantees are often necessary for applications that rely on the order of operations.

However, in our app it is not necessary, as pods are separated and are not communicating with each other.

### Implement a way to instruct the StatefulSet controller to launch or terminate all Pods in parallel

Added `podManagementPolicy: Parallel` to the statefulset.yaml.


## Bonus
I have implemented the statefulset from the main part for the helm-app-javascript chart.

 - `kubectl get po`

```bash
kubectl get po
NAME                                         READY   STATUS    RESTARTS        AGE
helm-app-javascrtipt-helm-app-javascript-0   1/1     Running   0               71s
helm-app-javascrtipt-helm-app-javascript-1   1/1     Running   0               71s
helm-app-python-0                            2/2     Running   1 (6m16s ago)   6m48s
helm-app-python-1                            2/2     Running   1 (75s ago)     6m48s
vault-0                                      1/1     Running   4 (10m ago)     14d
vault-agent-injector-dbfc5cd77-s65nw         1/1     Running   4 (11m ago)     14d
web-0                                        1/1     Running   2 (11m ago)     7h
web-1                                        1/1     Running   2 (11m ago)     7h
```

 - `kubectl get sts`

```bash
NAME                                       READY   AGE
helm-app-javascrtipt-helm-app-javascript   2/2     2m6s
helm-app-python                            2/2     7m43s
vault                                      1/1     14d
web                                        2/2     27h
```

 - `kubectl exec pod/helm-app-javascrtipt-helm-app-javascript-0 -- cat visits/visits`

```
17
```

 - `kubectl exec pod/helm-app-javascrtipt-helm-app-javascript-1 -- cat visits/visits`

```
20
```

### Explore Update Strategies

Based on [this](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#update-strategies) information, there are two update strategies:

#### OnDelete

User manually deletes pods and controller creates new pods with the modifications.

#### RollingUpdate

Default udpate strategy. StatefulSet controller deletes and recreates each Pod in StatefulSet itself. Will proceed from the largest ordinal to the smallest, one at a time.
